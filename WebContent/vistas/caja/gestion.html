
<form name="formulario" role="form" id="formulario" method="post"
	action="../caja/guardar" data-fv-excluded="disabled"
	data-fv-icon-valid="glyphicon glyphicon-ok"
	data-fv-icon-invalid="glyphicon glyphicon-remove"
	data-fv-icon-validating="glyphicon glyphicon-refresh">

	<div class="modal fade" id="modalAdicionar" tabindex="-1" role="dialog"
		aria-labelledby="myModalLabel">

		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="myModalLabel">Adicionar Nueva caja</h4>
				</div>
				<div class="modal-body">
					<div class="form-group row">
						<label class="col-md-3">Fecha</label>
						<div class="col-md-9">
						<input type="text" id="fini" name="fini" class="form-control input-sm text-right" data-fv-notempty="true" readonly="readonly" value="$!{xfecha}"/>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-md-3">Usuario</label> 
						<div class="col-md-9">
						<select name="codusu" id="codusu"
							class="form-control input-sm" data-fv-notempty="true">
							<option value="">[Seleccionar]</option> #foreach($u in $usuarios)
							<option value="$u.codusu">$u.nombre $u.ap $!{u.am}</option> #end
						</select>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-md-3">Monto de inicio</label> 
						<div class="col-md-9">
						<input type="text" id="monini"
							name="monini" class="form-control input-sm text-right"
							data-fv-notempty="true" data-fv-numeric="true" />
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">
						<i class="glyphicon glyphicon-remove-sign"></i> Cancelar
					</button>
					<button type="submit" id="btnAdicionarConfirmacion"
						class="btn btn-primary">
						<i class="glyphicon glyphicon-floppy-disk"></i> Guardar
					</button>
				</div>
			</div>
		</div>

	</div>
</form>
<div class="modal fade" id="modalEliminar" tabindex="-1" role="dialog"
	aria-labelledby="myModalLabel">
	<form name="formularioEliminar" role="form" id="formularioEliminar"
		method="post" action="../caja/eliminar" data-fv-excluded="disabled"
		data-fv-icon-valid="glyphicon glyphicon-ok"
		data-fv-icon-invalid="glyphicon glyphicon-remove"
		data-fv-icon-validating="glyphicon glyphicon-refresh">
		<div class="modal-dialog " style="width: 40%" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="myModalLabel">Eliminar caja</h4>
				</div>
				<div class="modal-body">
					<input type="hidden" id="codcaja3" name="codcaja" />
					<div class="form-group row">
						<label class="col-sm-2">Usuario</label>
						<div class="col-sm-10">
							<input type="text" class="form-control-plain-text"
								name="xusuario" style="border: 0" />
						</div>
					</div>
					<div class="form-group row">
						<label class="col-sm-2">Sucursal</label>
						<div class="col-sm-10">
							<input type="text" class="form-control-plaintext"
								name="xsucursal" style="border: 0" readonly="readonly" />
						</div>
					</div>
					<div class="form-group row">
						<label class="col-sm-2">Fecha</label>
						<div class="col-sm-10">
							<input type="text" class="form-control-plaintext" name="xfecha"
								style="border: 0" readonly="readonly" />
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">
						<i class="glyphicon glyphicon-remove-sign"></i> Cancelar
					</button>
					<button type="submit" class="btn btn-primary">
						<i class="glyphicon glyphicon-ok"></i> Aceptar
					</button>
				</div>
			</div>
		</div>
	</form>
</div>

<div class="modal fade" id="modalFinalizar" tabindex="-1" role="dialog"
	aria-labelledby="myModalLabel">
	<form name="formularioFinalizar" role="form" id="formularioFinalizar"
		method="post" action="../caja/finalizar" data-fv-excluded="disabled"
		data-fv-icon-valid="glyphicon glyphicon-ok"
		data-fv-icon-invalid="glyphicon glyphicon-remove"
		data-fv-icon-validating="glyphicon glyphicon-refresh">
		<div class="modal-dialog " role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title" id="myModalLabel">Finalizar caja</h4>
				</div>
				<div class="modal-body">
					<input type="hidden" id="codcaja4" name="codcaja" />
							<div class="form-group">
								<label>Usuario</label>
								<input type="text" class="form-control input-sm" id="xusuario2" name="xusuario2" readonly="readonly"/>
							</div>
							<div class="form-group">
								<label>Fecha</label>
								<input type="text" class="form-control input-sm" id="xffin2" name="ffin" readonly="readonly" />
							</div>
							<div class="row">
								<div class="col-md-6">
								<div class="form-group">
								<label>Monto Inicial</label>
								<input type="text" class="form-control input-sm" id="xxmonini" name="moninix" readonly="readonly"/>
							</div>
								</div>
								<div class="col-md-6">
								<div class="form-group">
								<label>Monto final sistema</label>
								<input type="text" class="form-control input-sm" id="xmonfin2" name="monsistema" readonly="readonly"/>
							</div>
								</div>	
							</div>
							
							<div class="form-group">
								<label>Monto final</label>
								<input type="text" class="form-control input-sm" id="monfin" name="monfin" onClick="this.setSelectionRange(0, this.value.length)" />
							</div>
							<div class="form-group">
								<label>Observacion</label>
								<textarea name="observacion" id="observacion" class="form-control"></textarea>
							</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-dismiss="modal">
						<i class="glyphicon glyphicon-remove-sign"></i> Cancelar
					</button>
					<button type="submit" class="btn btn-primary">
						<i class="glyphicon glyphicon-ok"></i> Aceptar
					</button>
				</div>
			</div>
		</div>
	</form>
</div>

<div class="row">
	<div class="col-lg-12">
		<div class="panel panel-default">
			<div class="panel-body">
				<div class="dataTable_wrapper">
					<table id="example"
						class="w3-table-all w3-tiny w3-table-hoverable w3-card-4">
						<thead>
							<tr>
								<th>Cod.</th>
								<th>Sucursal</th>
								<th>Usuario</th>
								<th>Fecha</th>
								<th>M. inicial</th>
								<th width="350px"></th>
							</tr>
						</thead>
						<tbody>

						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript">
                        var xtipo=['Pendiente','Finalizado'];
                        $(document).ready(function() {
                        	$('.fecha').mask('00/00/0000 00:00',{placeholder:"__/__/____ __:__"});
                        	$('select').chosen({no_results_text: "No se encuentra:",width:'90%'});
                        	$('#example').DataTable( {
                        		"oLanguage": {
                                    "sUrl": "../../js/Spanish.lang"
                                },
                                "dom":"<'row w3-tiny'<'col-sm-8'<'#tableTitle'>><'col-sm-1'<'#tableHeader.pull-right'>><'col-sm-3'f>><'row'<'col-sm-12'tr>><'row w3-tiny'<'col-sm-5'i><'col-sm-7'p>>",
                      			"processing": true,
                      		    "serverSide": true,
                      		    "ajax": {
                      		    	"type": "POST",
                      	            "url": "../caja/lista",
                      	        	"data": function ( d ) {
                      	                d.estado = 1;
                      	            }
                              	},
                      		    "columns": [
                      		    	{ "data": "codcaja","name": "codcaja"},        
                      		    	{ "data": "xsucursal","name": "xsucursal"},
                      		              	{ "data": "xusuario","name": "xusuario"},
                      		            	{ "data": "xfecha","name": "xfecha"},
                      		            	{ "data": "monini","name": "monini"},
                      		            	{ "data": "codcaja","name": "codcaja"}
                      		    ],
                      		    "createdRow": function ( row, data, index ){
                      		    	if(data.estado){
                          		    	var group='<div class="w3-bar">';
                          		    	group+='<button class="btn btn-xs btn-warning subgestion"  data-toggle="tooltip" data-placement="top" title="subgestion" data-id="'+data.codcaja+'"><i class="glyphicon glyphicon-log-in"></i> | Detalles</button>';
										if(data.tipo == 1){
											group+='<button class="btn btn-xs btn-success finalizar"  data-toggle="tooltip" data-placement="top" title="Finalizar" data-id="'+data.codcaja+'"><i class="glyphicon glyphicon-floppy-saved"></i> | Cerrar</button>';
	                      		    		group+='<button class="btn btn-xs btn-danger eliminar"  data-toggle="tooltip" data-placement="top" title="Eliminar" data-id="'+data.codcaja+'"><i class="glyphicon glyphicon-remove"></i> | Eliminar</button>';	
										}                      		    		
                      		    		group+='<button class="btn btn-xs btn-info imprimir"  data-toggle="tooltip" data-placement="top" title="Imprimir" data-id="'+data.codcaja+'"><i class="glyphicon glyphicon-remove"></i> | Imprimir</button>';
                      		    		group+='</div>';
                      		    		$('td', row).eq(5).html(group);
                      		    	}
                      	        },
                      	        "drawCallback": function( settings ) {
                      	        	$('#tableTitle').html('<h6><b>Gestion Cajas</b></h6>');
                      	        	$('#tableHeader').html('<button class="btn btn-sm btn-primary" id="btnAdicionar"><i class="fa fa-plus-circle"></i> | adicionar</button>');
                      	        	$('#btnAdicionar').click(function(){
                                		$('#formulario').data('formValidation').resetForm();
                                		$('#formulario')[0].reset();
                                		$('#fini').val(moment().format('DD/MM/YY'));
                                		$('#modalAdicionar').modal('show');
                                	});
                      	        	$('.subgestion').click(function(){ 
                      	        		$.post('../caja/gestionDetalle?codcaja='+$(this).data('id'), function(resp) {
                          	      			$("#contenedor").html(resp);
                          	  	    	});
                              		});
                              		$('.eliminar').click(function(){ 
                              			$('#formularioEliminar').data('formValidation').resetForm();
                                		$('#formularioEliminar')[0].reset();
                                  		$.post('../caja/obtener?codcaja='+$(this).data('id'), function(result) {
                      		            	if(result.status){
                      			    	        $('#modalEliminar').modal('show');
                      							$('#formularioEliminar').loadJSON(result.data);
                      		            	}else{
                      		            		mostrarMensaje('error','No se realizo con exito la Transacciion');
                      		            	}
                      			        }, 'json');
                              		});
                              		$('.finalizar').click(function(){ 
                              			$('#formularioFinalizar').data('formValidation').resetForm();
                                		$('#formularioFinalizar')[0].reset();
                                  		$.post('../caja/obtener?codcaja='+$(this).data('id'), function(result) {
                      		            	if(result.status){
                      			    	        $('#modalFinalizar').modal('show');
                      							$('#formularioFinalizar').loadJSON(result.data);
                      							$('#xffin2').val(result.fecha);
                      							$('#xusuario2').val(result.data.xusuario);
                      							$('#xxmonini').val(result.data.monini);
                      							$('#xmonfin2').val(result.data.monsistema);
                      		            	}else{
                      		            		mostrarMensaje('error','No se realizo con exito la Transacciion');
                      		            	}
                      			        }, 'json');
                              		});
                              		$('.imprimir').click(function(){ 
                              			$("#frameReportes").attr("src",'../caja/imprimir?codcaja='+$(this).data('id'));
                            			$("#reportes").modal('show');
                              		});
                              		$('button[data-toggle="tooltip"]').tooltip({animated: 'fade',placement: 'bottom',});
                      	        }
                        } );
                        	
                        $('#formulario,#formularioEliminar,#formularioFinalizar').formValidation(
                  				{locale: 'es_ES'}).on('success.form.fv', function(e) {
                              e.preventDefault();
                              var $form = $(e.target);
                              $.post($form.attr('action'), $form.serialize(), function(result) {
                              	if(result.status){
                      	            $form.data('formValidation').resetForm();
                      	          	$('#formulario')[0].reset();
                      	            $('#formularioEliminar')[0].reset();
									$('#example').dataTable().fnDraw('page');
                      	        	mostrarMensaje('info','Se realizo con exito la Transaccion');
                      	        }else{
                              		mostrarMensaje('error','No se realizo con exito la Transaccin');
                              	}
                            	$('.modal').modal('hide');
                      	    }, 'json');
                          });
                        });
                        </script>
